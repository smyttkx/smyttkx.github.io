<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>官方页面</title>
    <style>
        /* 全屏基础样式 */
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
       .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: #333;
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 16px;
            z-index: 1000;
        }
       .content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingMsg">正在进行检测网站是否安全，请稍候...</div>
    <script>
        const whitelistUrl = "https://wx.simeiyu.asia/smy.php";
        const loadingMsg = document.getElementById('loadingMsg');
        const DETECTION_DELAY = 3500; // 检测停留时间（3.5秒，3500毫秒）

        // 获取白名单（严格过滤空值/空格）
        async function fetchWhitelist() {
            console.groupCollapsed("[DEBUG] 获取白名单");
            try {
                const response = await fetch(whitelistUrl);
                if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                const text = await response.text();
                const whitelist = text.split('\n')
                                       .map(line => line.trim())
                                       .filter(line => line !== '');
                console.log("[INFO] 有效白名单:", whitelist);
                console.groupEnd();
                return whitelist;
            } catch (error) {
                console.error("[ERROR] 获取白名单失败，使用默认白名单");
                console.groupEnd();
                return ["tm.sjtztz.xyz"]; // 默认白名单（无空值）
            }
        }

        // 严格域名验证（精确匹配或带点号子域名）
        function isDomainAllowed(domain, whitelist) {
            console.groupCollapsed("[DEBUG] 验证域名");
            console.log("[INFO] 目标域名:", domain);
            console.log("[INFO] 有效白名单:", whitelist);
            
            const allowed = whitelist.some(allowedDomain => 
                domain === allowedDomain || 
                domain.endsWith('.' + allowedDomain)
            );
            console.log("[RESULT] 域名是否允许:", allowed);
            console.groupEnd();
            return allowed;
        }

        // 主逻辑（含3.5秒检测延迟）
        async function main() {
            console.group(`[MAIN] 检测流程开始（停留${DETECTION_DELAY/1000}秒）`);
            
            try {
                // 1. 显示检测提示并停留3.5秒
                loadingMsg.style.display = 'block';
                console.log(`[STEP] 检测提示显示，即将停留${DETECTION_DELAY/1000}秒`);
                await new Promise(resolve => setTimeout(resolve, DETECTION_DELAY));

                // 2. 解析URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const encodedParam = urlParams.get('c');
                if (!encodedParam) throw new Error("参数c缺失，未提供URL");
                console.log("[STEP] 参数c值:", encodedParam);

                // 3. 解码URL（Base64）
                const tureurl = atob(encodedParam);
                if (!tureurl.startsWith('http')) throw new Error("URL格式错误，必须以http/https开头");
                console.log("[STEP] 解码后URL:", tureurl);

                // 4. 解析域名
                const urlObj = new URL(tureurl);
                const domain = urlObj.hostname;
                console.log("[STEP] 解析出域名:", domain);

                // 5. 获取白名单
                const whitelist = await fetchWhitelist();
                if (whitelist.length === 0) throw new Error("白名单为空，不允许任何域名");

                // 6. 验证域名
                const isAllowed = isDomainAllowed(domain, whitelist);

                // 7. 处理结果
                if (isAllowed) {
                    console.log("[STEP] 域名允许，加载全屏iframe");
                    loadingMsg.style.display = 'none'; // 隐藏检测提示
                    const iframe = document.createElement('iframe');
                    iframe.className = 'content'; // 应用全屏样式
                    iframe.src = tureurl;
                    document.body.appendChild(iframe);
                } else {
                    console.log("[STEP] 域名不允许，显示禁止提示");
                    loadingMsg.textContent = "思梅雨专用接口 请勿调用";
                    loadingMsg.style.color = "#ff4444";
                    loadingMsg.style.fontWeight = "bold";
                }

            } catch (error) {
                console.error("[ERROR] 检测流程异常:", error.message);
                loadingMsg.textContent = `错误: ${error.message}`;
                loadingMsg.style.color = "#ff4444";
            } finally {
                console.groupEnd();
            }
        }

        // 启动检测
        main();
    </script>
</body>
</html>
